<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å…±ä¹˜æœå‹™</title>
<link rel="icon" type="image/png" href="./icon.png">
<link rel="apple-touch-icon" href="./icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="./icon.png">
<meta name="description" content="å…±ä¹˜æœå‹™ - æ—…è¡Œé¢¨é•·è¼©å‹å–„" />
<style>
:root{
  --bg:#f0f9f4; --card:#fffefc; --accent:#1d4d2f; --accent-light:#6aa37f;
  --text:#1b3b30; --muted:#4b5a4f; --danger:#d9534f;
}
*{box-sizing:border-box;}
body{margin:0;background:linear-gradient(180deg,var(--bg), #e6f2ea);font-family:"Noto Sans TC","Microsoft JhengHei",Arial,sans-serif;color:var(--text);padding:12px;}
.wrap{max-width:920px;margin:0 auto;}
header{display:flex;flex-direction:column;gap:6px;padding:12px 6px;}
h1{font-size:28px;margin:0;}
.lead{color:var(--muted);font-size:14px;}
.station{font-size:15px;font-weight:800;color:#2f7a57;}
.card{background:var(--card);border-radius:12px;padding:14px;margin:12px 0;box-shadow:0 6px 18px rgba(50,80,60,0.03);}
.buttons-row{display:flex;flex-direction:column;gap:10px;}
.time-btn{padding:14px;font-size:17px;font-weight:800;border-radius:12px;border:2px solid transparent;background:linear-gradient(180deg,#fff7d9,#ffeaa3);color:#6b4a05;cursor:pointer;text-align:center;box-shadow:0 4px 10px rgba(0,0,0,0.04);}
.time-btn.selected{background:#ffc107;color:#3b2b00;transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.12);}
.name-area{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;}
.name-input{flex:1;padding:14px;font-size:18px;border-radius:10px;border:3px solid #fff176;background:#fffdf6;}
.add-btn{padding:14px 18px;font-size:18px;border-radius:10px;background:var(--accent);color:#fff;border:none;font-weight:900;cursor:pointer;}
.lists{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;}
.list-title{background:var(--accent);color:#fff;padding:8px;border-radius:8px;text-align:center;font-weight:900;}
.slot-card{padding:12px;border-radius:14px;background:linear-gradient(180deg,#fff,#f7fff2);border:1px solid rgba(45,80,60,0.06);box-shadow:0 6px 18px rgba(45,80,60,0.03);margin-bottom:10px;}
.slot-info{font-weight:900;color:#25573b;font-size:16px;}
.slot-desc{color:var(--muted);margin-top:6px;font-size:15px;}
.slot-line{margin-top:6px;font-size:15px;color:#2f6e4f;}
.slot-list{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:12px;}
.seat{min-height:44px;border-radius:8px;padding:8px;border:1px dashed rgba(47,122,87,0.08);display:flex;align-items:center;gap:8px;font-size:15px;background:#fff;}
.seat.filled{background:linear-gradient(180deg,#e6fff1,#ddfbe6);}
.cancel-btn{margin-left:auto;background:#d9534f;color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer;font-weight:800;}
.delete-slot-btn{margin-top:10px;width:100%;background:#c62828;color:#fff;border:none;padding:10px;border-radius:10px;font-weight:900;cursor:pointer;}
.info-line{font-size:13px;color:var(--muted);margin-top:6px;}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(40,90,60,0.95);color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:9999;}
.loading{display:inline-block;width:18px;height:18px;border-radius:50%;border:3px solid rgba(0,0,0,0.1);border-top-color:var(--accent);animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:860px){.lists{grid-template-columns:1fr}}
.small-muted{font-size:13px;color:#6e6e6e}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ğŸš• å…±ä¹˜æœå‹™</h1>
    <div class="lead">æ—…è¡Œé¢¨ â€¢ é•·è¼©å‹å–„ â€¢ æ‰‹æ©Ÿå„ªåŒ–</div>
    <div class="station">ğŸ“ çƒæ—¥é«˜éµç«™ä¸Šè»Šåœ°é»: 1F è¼‰å®¢å€ï¼Œ1è™Ÿæœƒé¢é»</div>
  </header>

  <div class="card" aria-live="polite">
    <div id="topInfo" class="info-line small-muted">è¼‰å…¥ä¸­â€¦ <span class="loading" id="topLoading"></span></div>

    <div class="buttons-row" id="buttonsRow"></div>

    <div class="name-area">
      <input id="nameInput" class="name-input" placeholder="è«‹è¼¸å…¥ä¸­æ–‡å…¨åï¼ˆç¯„ä¾‹ï¼šæ´ªåƒæ·‘ï¼‰" />
      <button id="btnJoin" class="add-btn">åŠ å…¥åå–®</button>
    </div>
    <div class="info-line" id="remainInfo"></div>
  </div>

  <div class="lists">
    <div>
      <div class="list-title">å»ç¨‹</div>
      <div id="goListArea"></div>
    </div>
    <div>
      <div class="list-title">å›ç¨‹</div>
      <div id="backListArea"></div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ======= å‰ç«¯ (index.html) =======
   - æŠŠ API_URL æ›æˆä½ éƒ¨ç½²å¾Œçš„ Apps Script exec URL
*/
const API_URL = "https://script.google.com/macros/s/AKfycbwk-2tYwoRW3iKBFYm8uFrGHd0zrQLNBKM-sKzkeUXrQtswKDPt0L6wV89YyuneT0tNlA/exec"; // <- **éƒ¨ç½²å¾ŒæŠŠä½ çš„ exec URL è²¼åœ¨é€™è£¡**
const FIXED_QUOTA = 16;
const SLOT_OPTIONS = [
  { type:'go', date:'2025-12-12', time:'15:40', desc:'å‰ä¸€å¤©å…¥ä½' },
  { type:'go', date:'2025-12-13', time:'07:30', desc:'æ—©ä¸Š' },
  { type:'go', date:'2025-12-14', time:'07:30', desc:'æ—©ä¸Š' },
  { type:'back', date:'2025-12-13', time:'17:30', desc:'å›ç¨‹' },
  { type:'back', date:'2025-12-14', time:'17:10', desc:'å›ç¨‹' }
];

let rides = [];        // å¾Œç«¯å›ä¾†çš„ raw è³‡æ–™ array
let SELECTED = null;   // ç›®å‰é¸åˆ°çš„ slot object
let scrollToId = null; // åŠ å…¥å¾Œè¦æ»¾å‹•åˆ°çš„ id

/* ---------- helpers ---------- */
function $ (id){return document.getElementById(id);}
function toast(msg,timeout=1800){
  const t=$('toast'); t.textContent=msg; t.style.display='block';
  setTimeout(()=>t.style.display='none', timeout);
}
function showTopLoading(show){
  $('topLoading').style.display = show ? 'inline-block' : 'none';
}

/* è½‰æ›èˆ‡æ ¼å¼åŒ– */
function weekdayOf(dateStr){
  const dt = new Date(dateStr + 'T00:00:00');
  return ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dt.getDay()];
}
function formatPrettyDate(dateStr){
  if(!dateStr) return '';
  const dt = new Date(dateStr + 'T00:00:00');
  if(isNaN(dt.getTime())) return dateStr;
  const mm = String(dt.getMonth()+1).padStart(2,'0');
  const dd = String(dt.getDate()).padStart(2,'0');
  const w = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dt.getDay()];
  return `${mm}/${dd}ï¼ˆ${w}ï¼‰`;
}
function formatPrettyTime(timeStr){
  if(!timeStr) return '';
  // timeStr is like "15:40"
  return timeStr;
}
function slotLabel(s){
  const mmdd = s.date.slice(5).replace('-','/');
  const w = weekdayOf(s.date);
  const ampm = Number(s.time.split(':')[0]) < 12 ? 'æ—©ä¸Š' : 'ä¸‹åˆ';
  return `${mmdd}(${w}) ${ampm}${s.time}ï¼ˆ${s.desc}ï¼‰`;
}

/* ---------- ç”¢ç”ŸæŒ‰éˆ• ---------- */
function renderSlotButtons(){
  const wrap = $('buttonsRow'); wrap.innerHTML = '';
  SLOT_OPTIONS.forEach(s=>{
    const btn = document.createElement('button');
    btn.className = 'time-btn';
    btn.textContent = slotLabel(s);
    btn.onclick = ()=> {
      SELECTED = s;
      document.querySelectorAll('.time-btn').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      toast('å·²é¸æ“‡æ™‚æ®µï¼š' + s.date + ' ' + s.time);
      updateRemainInfo();
    };
    wrap.appendChild(btn);
  });
}

/* ---------- API ---------- */
async function apiGet(){
  showTopLoading(true);
  try{
    const res = await fetch(API_URL);
    const json = await res.json();
    if(!json.success) throw new Error('å¾Œç«¯å›å‚³éŒ¯èª¤');
    rides = json.data || [];
    renderLists();
  }catch(err){
    console.error(err);
    toast('ç„¡æ³•å–å¾—è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–å¾Œç«¯éƒ¨ç½²');
  }finally{
    showTopLoading(false);
  }
}

async function apiPostAdd(payload){
  const body = Object.assign({ action: 'add' }, payload);
  const res = await fetch(API_URL, { method:'POST', body: JSON.stringify(body) });
  return res.json();
}

async function apiPostAction(action, payload){
  const body = Object.assign({ action }, payload);
  const res = await fetch(API_URL, { method:'POST', body: JSON.stringify(body) });
  return res.json();
}

/* ---------- åŠ å…¥åå–® ---------- */
$('btnJoin').addEventListener('click', async ()=>{
  const name = $('nameInput').value.trim();
  if(!SELECTED){ alert('è«‹å…ˆé¸æ“‡æ™‚æ®µ'); return; }
  if(!name){ alert('è«‹è¼¸å…¥å§“å'); $('nameInput').focus(); return; }

  const slotKey = (s)=> `${s.type}|${s.date}|${s.time}|${s.desc}`;
  const existing = rides.filter(r => slotKey(r) === slotKey(SELECTED));
  if(existing.length >= FIXED_QUOTA){
    alert('æ­¤æ™‚æ®µå·²æ»¿ ' + FIXED_QUOTA + ' äºº');
    return;
  }

  $('btnJoin').disabled = true;
  $('btnJoin').textContent = 'åŠ å…¥ä¸­â€¦';
  try{
    const payload = { date: SELECTED.date, time: SELECTED.time, type: SELECTED.type, desc: SELECTED.desc, name };
    const json = await apiPostAdd(payload);
    if(json && json.success){
      $('nameInput').value = '';
      toast('å·²åŠ å…¥åå–®');
      scrollToId = json.id || null;
      await apiGet();
    } else {
      throw new Error(json && json.message ? json.message : 'æ–°å¢å¤±æ•—');
    }
  }catch(err){
    console.error(err);
    toast('åŠ å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }finally{
    $('btnJoin').disabled = false;
    $('btnJoin').textContent = 'åŠ å…¥åå–®';
  }
});

/* ---------- åˆªé™¤å–®ç­† / åˆªé™¤æ™‚æ®µ ---------- */
async function deleteName(id){
  if(!confirm('ç¢ºå®šåˆªé™¤æ­¤å§“åï¼Ÿ')) return;
  try{
    const json = await apiPostAction('deleteName', { id });
    if(json && json.success){
      toast('å·²åˆªé™¤');
      await apiGet();
    } else {
      throw new Error(json.message||'åˆªé™¤å¤±æ•—');
    }
  }catch(err){
    toast('åˆªé™¤å¤±æ•—');
  }
}

async function deleteSlot(type,date,time,desc){
  if(!confirm('ç¢ºå®šåˆªé™¤æ•´å€‹æ™‚æ®µå…¨éƒ¨åå–®ï¼Ÿ')) return;
  try{
    const json = await apiPostAction('deleteSlot', { type, date, time, desc });
    if(json && json.success){
      toast('å·²åˆªé™¤æ™‚æ®µ');
      await apiGet();
    } else {
      throw new Error(json.message||'åˆªé™¤æ™‚æ®µå¤±æ•—');
    }
  }catch(err){
    toast('åˆªé™¤æ™‚æ®µå¤±æ•—');
  }
}

/* ---------- å®Œæ•´ renderLists()ï¼ˆç¾åŒ–ç‰ˆï¼‰ ---------- */
function renderLists() {
  const slotKey = (s) => `${s.type}|${s.date}|${s.time}|${s.desc}`;

  // åˆ†çµ„ ridesï¼škey = type|date|time|desc â†’ array of rows
  const groups = {};
  rides.forEach(r => {
    const key = slotKey(r);
    if (!groups[key]) groups[key] = [];
    groups[key].push(r);
  });

  // ä»¥é è¨­ SLOT_OPTIONS ç‚ºä¸»é †åºï¼ˆè‹¥å¾Œç«¯æœ‰å…¶ä»–æ™‚æ®µä¹Ÿæœƒè¢«å¿½ç•¥ï¼‰
  const sortedSlots = SLOT_OPTIONS.slice().sort((a,b)=>{
    const ad = a.date + ' ' + a.time;
    const bd = b.date + ' ' + b.time;
    return ad.localeCompare(bd);
  });

  const goArea = $('goListArea');
  const backArea = $('backListArea');
  goArea.innerHTML = '';
  backArea.innerHTML = '';

  sortedSlots.forEach(slot => {
    const key = slotKey(slot);
    const list = groups[key] || [];

    const card = document.createElement('div');
    card.className = 'slot-card';

    // header: è·¯ç·š + åœ°é»
    const infoDiv = document.createElement('div');
    infoDiv.className = 'slot-info';
    infoDiv.textContent = slot.type === 'go' ? 'å°ä¸­é«˜éµ â†’ è˜ç•«å±…' : 'è˜ç•«å±… â†’ å°ä¸­é«˜éµ';
    card.appendChild(infoDiv);

    // place
    const placeLine = document.createElement('div');
    placeLine.className = 'slot-line';
    placeLine.textContent = slot.type === 'go' ? 'ğŸ“ çƒæ—¥é«˜éµç«™ä¸Šè»Šåœ°é»ï¼š1F è¼‰å®¢å€ï¼Œ1è™Ÿæœƒé¢é»' : 'ğŸ“ è˜ç•«å±…';
    card.appendChild(placeLine);

    // date/time & desc
    const dtLine = document.createElement('div');
    dtLine.className = 'slot-line';
    dtLine.innerHTML = `ğŸ•’ ${formatPrettyDate(slot.date)} ${formatPrettyTime(slot.time)} &nbsp; <span style="color:#6e6e6e">Â· ${slot.desc}</span>`;
    card.appendChild(dtLine);

    // quota info
    const quotaLine = document.createElement('div');
    quotaLine.className = 'info-line';
    quotaLine.textContent = `åé¡ï¼š${list.length} / ${FIXED_QUOTA}`;
    card.appendChild(quotaLine);

    // seats
    const grid = document.createElement('div');
    grid.className = 'slot-list';

    for (let i = 0; i < FIXED_QUOTA; i++) {
      const box = document.createElement('div');
      box.className = 'seat';
      if (list[i]) {
        box.classList.add('filled');
        box.id = 'seat-' + list[i].id;
        const nameSpan = document.createElement('span');
        nameSpan.textContent = list[i].name;
        box.appendChild(nameSpan);
        const btn = document.createElement('button');
        btn.className = 'cancel-btn';
        btn.textContent = 'åˆªé™¤';
        btn.onclick = ()=> deleteName(list[i].id);
        box.appendChild(btn);
      } else {
        box.textContent = 'ç©ºä½';
      }
      grid.appendChild(box);
    }
    card.appendChild(grid);

    // delete slot button (é¡¯çœ¼)
    const delAllBtn = document.createElement('button');
    delAllBtn.className = 'delete-slot-btn';
    delAllBtn.textContent = 'åˆªé™¤æ­¤æ™‚æ®µå…¨éƒ¨åå–®';
    delAllBtn.onclick = ()=> deleteSlot(slot.type, slot.date, slot.time, slot.desc);
    card.appendChild(delAllBtn);

    if (slot.type === 'go') goArea.appendChild(card);
    else backArea.appendChild(card);
  });

  // æ»¾å‹•åˆ°æ–°å¢çš„ idï¼ˆå¦‚æœ‰ï¼‰
  if (scrollToId) {
    const el = document.getElementById('seat-' + scrollToId);
    if (el) {
      setTimeout(()=>{ el.scrollIntoView({behavior:'smooth', block:'center'}); scrollToId = null; }, 150);
    } else {
      scrollToId = null;
    }
  }

  updateRemainInfo();
}

/* ---------- é¡¯ç¤ºå‰©é¤˜åé¡ ---------- */
function updateRemainInfo(){
  if(!SELECTED){ $('remainInfo').textContent = 'è«‹é¸æ“‡æ™‚æ®µ'; return; }
  const key = (s)=> `${s.type}|${s.date}|${s.time}|${s.desc}`;
  const curCount = rides.filter(r => key(r) === key(SELECTED)).length;
  const left = Math.max(0, FIXED_QUOTA - curCount);
  $('remainInfo').textContent = `æ­¤æ™‚æ®µå‰©é¤˜åé¡ï¼š${left} / ${FIXED_QUOTA}`;
}

/* ---------- auto refresh ---------- */
let pollTimer = null;
function startPolling(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(()=> apiGet(), 3000);
}

/* ---------- init ---------- */
function init(){
  renderSlotButtons();
  apiGet();
  startPolling();
}
init();
</script>
</body>
</html>
