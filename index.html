<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å…±ä¹˜æœå‹™</title>
<link rel="icon" type="image/png" href="./icon.png">
<link rel="apple-touch-icon" href="./icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="./icon.png">
<meta name="description" content="å…±ä¹˜æœå‹™ - æ—…è¡Œé¢¨é•·è¼©å‹å–„" />
<style>
/* ====== ä¸»è¦æ¨£å¼ (ç•¥éå¯åƒè€ƒå‰é¢ç‰ˆæœ¬) ====== */
:root{
  --bg:#f0f9f4; --card:#fffefc; --accent:#1d4d2f; --accent-light:#6aa37f;
  --text:#1b3b30; --muted:#4b5a4f; --danger:#d9534f;
}
*{box-sizing:border-box;}
body{margin:0;background:linear-gradient(180deg,var(--bg), #e6f2ea);font-family:"Noto Sans TC","Microsoft JhengHei",Arial,sans-serif;color:var(--text);padding:12px;}
.wrap{max-width:920px;margin:0 auto;}
header{display:flex;flex-direction:column;gap:6px;padding:12px 6px;}
h1{font-size:28px;margin:0;}
.lead{color:var(--muted);font-size:14px;}
.station{font-size:15px;font-weight:800;color:#2f7a57;}
.card{background:var(--card);border-radius:12px;padding:14px;margin:12px 0;box-shadow:0 6px 18px rgba(50,80,60,0.03);}
.buttons-row{display:flex;flex-direction:column;gap:10px;}
.time-btn{padding:14px;font-size:17px;font-weight:800;border-radius:12px;border:2px solid transparent;background:linear-gradient(180deg,#e0f7e8,#d9f0e0);color:var(--accent);cursor:pointer;text-align:center;}
.time-btn.selected{background:var(--accent);color:#fff;transform:translateY(-2px);}
.name-area{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;}
.name-input{flex:1;padding:14px;font-size:18px;border-radius:10px;border:3px solid #fff176;background:#fffdf6;}
.add-btn{padding:14px 18px;font-size:18px;border-radius:10px;background:var(--accent);color:#fff;border:none;font-weight:900;cursor:pointer;}
.lists{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;}
.list-title{background:var(--accent);color:#fff;padding:8px;border-radius:8px;text-align:center;font-weight:900;}
.slot-card{padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fafaf6);border:1px solid rgba(45,80,60,0.06);}
.slot-info{font-weight:900;color:var(--accent);}
.slot-desc{color:var(--muted);margin-top:4px;}
.slot-list{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px;}
.seat{min-height:44px;border-radius:8px;padding:8px;border:1px dashed rgba(47,122,87,0.08);display:flex;align-items:center;gap:8px;font-size:15px;}
.seat.filled{background:linear-gradient(180deg,#e6fff1,#ddfbe6);}
.cancel-btn{margin-left:auto;background:var(--danger);color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer;font-weight:800;}
.delete-slot-btn{margin-top:10px;width:100%;background:var(--danger);color:#fff;border:none;padding:8px;border-radius:8px;font-weight:900;cursor:pointer;}
.info-line{font-size:13px;color:var(--muted);margin-top:6px;}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(40,90,60,0.95);color:#fff;padding:10px 14px;border-radius:10px;display:none;}
.loading{display:inline-block;width:18px;height:18px;border-radius:50%;border:3px solid rgba(0,0,0,0.1);border-top-color:var(--accent);animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:860px){.lists{grid-template-columns:1fr}}
.small-muted{font-size:13px;color:#6e6e6e}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ğŸš• å…±ä¹˜æœå‹™</h1>
    <div class="lead">é•·è¼©å‹å–„ Â· å–®ä¸€é¸æ“‡æŒ‰éˆ•å¿«é€Ÿé¸æ“‡æ™‚æ®µ</div>
    <div class="station">ğŸ“ çƒæ—¥é«˜éµç«™ä¸Šè»Šåœ°é»: 1F è¼‰å®¢å€ï¼Œ1è™Ÿæœƒé¢é»</div>
  </header>

  <div class="card" aria-live="polite">
    <div id="topInfo" class="info-line small-muted">è¼‰å…¥ä¸­â€¦ <span class="loading" id="topLoading"></span></div>

    <div class="buttons-row" id="buttonsRow"></div>

    <div class="name-area">
      <input id="nameInput" class="name-input" placeholder="è«‹è¼¸å…¥ä¸­æ–‡å…¨åï¼ˆç¯„ä¾‹ï¼šæ´ªåƒæ·‘ï¼‰" />
      <button id="btnJoin" class="add-btn">åŠ å…¥åå–®</button>
    </div>
    <div class="info-line" id="remainInfo"></div>
  </div>

  <div class="lists">
    <div>
      <div class="list-title">å»ç¨‹</div>
      <div id="goListArea"></div>
    </div>
    <div>
      <div class="list-title">å›ç¨‹</div>
      <div id="backListArea"></div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ======= å‰ç«¯ (index.html) =======
   - é€™å€‹æª”æ¡ˆæ˜¯å‰ç«¯ï¼šæ”¾åˆ° GitHub Pages æˆ–ç›´æ¥é–‹å•Ÿ
   - è«‹æŠŠ API_URL æ”¹æˆä½ éƒ¨ç½²å¾Œçš„ Apps Script exec URL
*/
const API_URL = "https://script.google.com/macros/s/AKfycbyr2dnJbEIHO9X8ditDnhOMWnAr2q1o_GAgleDxvBfhzE2mOmC3RN2VaLI5z8yQ2OEdMA/exec"; // <- è‹¥å¾Œç«¯é‡æ–°éƒ¨ç½²ï¼Œè«‹æ”¹ç‚ºæœ€æ–° exec URL
const FIXED_QUOTA = 16;
const SLOT_OPTIONS = [
  { type:'go', date:'2025-12-12', time:'15:40', desc:'å‰ä¸€å¤©å…¥ä½' },
  { type:'go', date:'2025-12-13', time:'07:30', desc:'æ—©ä¸Š' },
  { type:'go', date:'2025-12-14', time:'07:30', desc:'æ—©ä¸Š' },
  { type:'back', date:'2025-12-13', time:'17:30', desc:'å›ç¨‹' },
  { type:'back', date:'2025-12-14', time:'17:10', desc:'å›ç¨‹' }
];

let rides = [];        // å¾Œç«¯å›ä¾†çš„ raw è³‡æ–™ array
let SELECTED = null;   // ç›®å‰é¸åˆ°çš„ slot object
let scrollToId = null; // åŠ å…¥å¾Œè¦æ»¾å‹•åˆ°çš„ id

/* ---------- helpers ---------- */
function $ (id){return document.getElementById(id);}
function toast(msg,timeout=1800){
  const t=$('toast'); t.textContent=msg; t.style.display='block';
  setTimeout(()=>t.style.display='none', timeout);
}
function showTopLoading(show){
  $('topLoading').style.display = show ? 'inline-block' : 'none';
}

/* å½¢æˆæŒ‰éˆ•æ–‡å­—ï¼Œé¡¯ç¤ºæ˜ŸæœŸ */
function weekdayOf(dateStr){
  const dt = new Date(dateStr + 'T00:00:00');
  return ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dt.getDay()];
}
function slotLabel(s){
  // è¼¸å‡ºï¼š12/12(äº”) ä¸‹åˆ15:40ï¼ˆå‰ä¸€å¤©å…¥ä½ï¼‰
  const mmdd = s.date.slice(5).replace('-','/');
  const w = weekdayOf(s.date);
  const ampm = Number(s.time.split(':')[0]) < 12 ? 'æ—©ä¸Š' : 'ä¸‹åˆ';
  return `${mmdd}(${w}) ${ampm}${s.time}ï¼ˆ${s.desc}ï¼‰`;
}

/* ---------- ç”¢ç”Ÿäº”å€‹å¤§æŒ‰éˆ• ---------- */
function renderSlotButtons(){
  const wrap = $('buttonsRow'); wrap.innerHTML = '';
  SLOT_OPTIONS.forEach(s=>{
    const btn = document.createElement('button');
    btn.className = 'time-btn';
    btn.textContent = slotLabel(s);
    btn.onclick = ()=> {
      SELECTED = s;
      document.querySelectorAll('.time-btn').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      toast('å·²é¸æ“‡æ™‚æ®µï¼š' + s.date + ' ' + s.time);
      updateRemainInfo();
    };
    wrap.appendChild(btn);
  });
}

/* ---------- è«‹æ±‚ API ---------- */
async function apiGet(){
  showTopLoading(true);
  try{
    const res = await fetch(API_URL);
    const json = await res.json();
    if(!json.success) throw new Error('å¾Œç«¯å›å‚³éŒ¯èª¤');
    rides = json.data || [];
    renderLists();
  }catch(err){
    console.error(err);
    toast('ç„¡æ³•å–å¾—è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–å¾Œç«¯éƒ¨ç½²');
  }finally{
    showTopLoading(false);
  }
}

async function apiPostAdd(payload){
  const body = Object.assign({ action: 'add' }, payload);
  const res = await fetch(API_URL, { method:'POST', body: JSON.stringify(body) });
  return res.json();
}

async function apiPostAction(action, payload){
  const body = Object.assign({ action }, payload);
  const res = await fetch(API_URL, { method:'POST', body: JSON.stringify(body) });
  return res.json();
}

/* ---------- åŠ å…¥åå–® ---------- */
$('btnJoin').addEventListener('click', async ()=>{
  const name = $('nameInput').value.trim();
  if(!SELECTED){ alert('è«‹å…ˆé¸æ“‡æ™‚æ®µ'); return; }
  if(!name){ alert('è«‹è¼¸å…¥å§“å'); $('nameInput').focus(); return; }

  // åé¡æª¢æŸ¥ï¼ˆå³æ™‚ä»¥å‰ç«¯è¨ˆç®—ï¼Œä½†æœ€çµ‚æœƒç”±å¾Œç«¯è³‡æ–™æ±ºå®šï¼‰
  const slotKey = (s)=> `${s.type}|${s.date}|${s.time}|${s.desc}`;
  const existing = rides.filter(r => slotKey(r) === slotKey(SELECTED));
  if(existing.length >= FIXED_QUOTA){
    alert('æ­¤æ™‚æ®µå·²æ»¿ ' + FIXED_QUOTA + ' äºº');
    return;
  }

  $('btnJoin').disabled = true;
  $('btnJoin').textContent = 'åŠ å…¥ä¸­â€¦';
  try{
    const payload = { date: SELECTED.date, time: SELECTED.time, type: SELECTED.type, desc: SELECTED.desc, name };
    const json = await apiPostAdd(payload);
    if(json && json.success){
      $('nameInput').value = '';
      toast('å·²åŠ å…¥åå–®');
      // è®“ renderLists åœ¨ä¸‹ä¸€æ¬¡ fetch æ™‚æ»¾å‹•åˆ°æ–°å¢çš„é‚£å€‹ idï¼ˆè‹¥å¾Œç«¯å›å‚³ idï¼‰
      scrollToId = json.id || null;
      await apiGet(); // é‡æ–°è®€å–æœ€æ–°è³‡æ–™
    } else {
      throw new Error(json && json.message ? json.message : 'æ–°å¢å¤±æ•—');
    }
  }catch(err){
    console.error(err);
    toast('åŠ å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }finally{
    $('btnJoin').disabled = false;
    $('btnJoin').textContent = 'åŠ å…¥åå–®';
  }
});

/* ---------- åˆªé™¤å–®ç­†å§“åï¼ˆé€é idï¼‰ ---------- */
async function deleteName(id){
  if(!confirm('ç¢ºå®šåˆªé™¤æ­¤å§“åï¼Ÿ')) return;
  try{
    const json = await apiPostAction('deleteName', { id });
    if(json && json.success){
      toast('å·²åˆªé™¤');
      await apiGet();
    } else {
      throw new Error(json.message||'åˆªé™¤å¤±æ•—');
    }
  }catch(err){
    toast('åˆªé™¤å¤±æ•—');
  }
}

/* ---------- åˆªé™¤æ•´å€‹æ™‚æ®µï¼ˆtype+date+time+descï¼‰ ---------- */
async function deleteSlot(type,date,time,desc){
  if(!confirm('ç¢ºå®šåˆªé™¤æ•´å€‹æ™‚æ®µå…¨éƒ¨åå–®ï¼Ÿ')) return;
  try{
    const json = await apiPostAction('deleteSlot', { type, date, time, desc });
    if(json && json.success){
      toast('å·²åˆªé™¤æ™‚æ®µ');
      await apiGet();
    } else {
      throw new Error(json.message||'åˆªé™¤æ™‚æ®µå¤±æ•—');
    }
  }catch(err){
    toast('åˆªé™¤æ™‚æ®µå¤±æ•—');
  }
}

/* ---------- render lists (grouping) ---------- */
function renderLists(){
  // rides ç‚º array of objects: {id,date,time,type,desc,name,createdAt}
  // å…ˆä¾ date,time æ’åº
  rides.sort((a,b)=>{
    if(a.date === b.date) return a.time.localeCompare(b.time);
    return a.date.localeCompare(b.date);
  });

  // å°‡åŒä¸€ slot èšåˆç‚ºä¸€å€‹ç‰©ä»¶: { date,time,type,desc, items: [{id,name}] }
  const slots = [];
  const mapKey = (r)=> `${r.type}|${r.date}|${r.time}|${r.desc}`;
  const map = {};
  rides.forEach(r=>{
    const k = mapKey(r);
    if(!map[k]) map[k] = { type:r.type, date:r.date, time:r.time, desc:r.desc, items: [] };
    map[k].items.push({ id: r.id, name: r.name, createdAt: r.createdAt });
  });
  Object.keys(map).forEach(k=> slots.push(map[k]));

  // render slots into go/back area
  const goArea = $('goListArea'); const backArea = $('backListArea');
  goArea.innerHTML = ''; backArea.innerHTML = '';

  slots.forEach((slot, idx) => {
    const container = document.createElement('div'); container.className='slot-card';
    const info = document.createElement('div'); info.className='slot-info';
    const locationText = slot.type==='go' ? 'çƒæ—¥é«˜éµç«™ä¸Šè»Šåœ°é»: 1F è¼‰å®¢å€ï¼Œ1è™Ÿæœƒé¢é»' : 'è˜ç•«å±…';
    info.textContent = `${slot.type==='go' ? 'å°ä¸­é«˜éµ â†’ è˜ç•«å±…' : 'è˜ç•«å±… â†’ å°ä¸­é«˜éµ'}ï½œ${locationText}`;
    const desc = document.createElement('div'); desc.className='slot-desc'; desc.textContent = `${slot.date} ï½œ ${slot.time} Â· ${slot.desc}`;
    container.appendChild(info); container.appendChild(desc);

    // seats grid
    const seats = document.createElement('div'); seats.className='slot-list';
    // show existing names first
    slot.items.forEach(it=>{
      const s = document.createElement('div'); s.className='seat filled'; s.textContent = it.name;
      const btn = document.createElement('button'); btn.className = 'cancel-btn'; btn.textContent = 'åˆªé™¤';
      btn.onclick = ()=> deleteName(it.id);
      s.appendChild(btn);
      seats.appendChild(s);
    });
    // empty seats
    const emptyCount = Math.max(0, FIXED_QUOTA - slot.items.length);
    for(let i=0;i<emptyCount;i++){
      const s = document.createElement('div'); s.className='seat'; s.textContent = 'ç©ºä½';
      seats.appendChild(s);
    }

    container.appendChild(seats);

    // é¡¯ç¤ºåˆªé™¤æ™‚æ®µæŒ‰éˆ•ï¼ˆæ˜é¡¯ï¼‰
    const delBtn = document.createElement('button'); delBtn.className='delete-slot-btn'; delBtn.textContent='åˆªé™¤æ­¤æ™‚æ®µå…¨éƒ¨åå–®';
    delBtn.onclick = ()=> deleteSlot(slot.type, slot.date, slot.time, slot.desc);
    container.appendChild(delBtn);

    if(slot.type === 'go') goArea.appendChild(container); else backArea.appendChild(container);

    // å¦‚æœéœ€è¦æ»¾å‹•åˆ°å‰›å‰›æ–°å¢çš„ idï¼ˆscrollToIdï¼‰ï¼Œå®šä½å¾Œæ»¾å‹•
    if(scrollToId){
      // å¦‚æœ slot.items è£¡åŒ…å«è©² idï¼Œæ»¾å‹•
      const found = slot.items.find(x=>x.id === scrollToId);
      if(found){
        setTimeout(()=>{ container.scrollIntoView({behavior:'smooth', block:'center'}); scrollToId = null; }, 200);
      }
    }
  });

  updateRemainInfo();
}

/* ---------- é¡¯ç¤ºå‰©é¤˜åé¡ç°¡æ˜“æç¤º ---------- */
function updateRemainInfo(){
  if(!SELECTED){ $('remainInfo').textContent = 'è«‹é¸æ“‡æ™‚æ®µ'; return; }
  // æ‰¾åˆ°è©² slot
  const key = (s)=> `${s.type}|${s.date}|${s.time}|${s.desc}`;
  const curCount = rides.filter(r => key(r) === key(SELECTED)).length;
  const left = Math.max(0, FIXED_QUOTA - curCount);
  $('remainInfo').textContent = `æ­¤æ™‚æ®µå‰©é¤˜åé¡ï¼š${left} / ${FIXED_QUOTA}`;
}

/* ---------- auto refresh æ¯ 3 ç§’æ‹‰ä¸€æ¬¡æœ€æ–°è³‡æ–™ ---------- */
let pollTimer = null;
function startPolling(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(()=> apiGet(), 3000);
}

/* ---------- init ---------- */
function init(){
  renderSlotButtons();
  apiGet();
  startPolling();
}
init();

</script>
</body>
</html>

